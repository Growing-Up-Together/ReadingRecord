# 2장. 설치와 설정

## 1. MySQL 서버 설치

### 버전과 에디션 선택

- 기존 버전에서 새로운 메이저 버전으로 업그레이 하는 경우라면 최소 패치 버전이 15~20번 이상 릴리스된 버전을 선택하는 것이 안정적이다.
    - **e.g.** MySQL 8.0 버전이라면, MySQL 8.0.15 부터 MySQL 8.0.20 버전부터 시작

- MySQL 5.5 버전부터는 커뮤니티와 엔터프라이즈 에디션의 기능이 달라지면서 소스코드도 달라졌고, MySQL 엔터프라이즈 에디션의 소스코드는 더이상 공개되지 않는다.

- MySQL 서버의 상용화 전략
    - 오픈 코어 모델 : 핵심 내용은 엔터프라이즈 에디션과 커뮤니티 에디션 모두 동일하며, 특정 부가 기능들만 상용 버전인 엔터프라이즈 에디션에 포함되는 방식
    - 즉, 엔터프라이즈 에디션과 커뮤니티 에디션의 핵심 기능은 거의 차이가 없고, 부가적인 기능과 서비스들은 엔터프라이즈 에이션에서만 지원된다.

## 2. MySQL 설치

### 리눅스 서버

- [Yum 인스톨러 사용](https://dev.mysql.com/downloads/repo/yum)
    - Yum 리포지토리 정보 등록
      ```shell
      sudo rpm -Uvh mysql80-community-release-el7-6.noarch.rpm
      ```
    - 버전별로 설치 가능한 MySQL 소프트웨어 목록을 확인
        ```shell
      sudo yum search mysql-community
      ```
    - MySQL 설치
      ```shell
      sudo yum install mysql-community-server-8.0.21
      ```
- [Yum 인스톨러를 사용하지 않고 RPM 패키지로 직접 설치](https://dev.mysql.com/downloads/mysql/)

### macOS 용 DMG 패키지 설치

- [DMG 패키지 파일 다운로드](https://dev.mysql.com/downloads/mysql/)
    - 설치 설정을 확인
        - MySQL 서버를 사설 네트워크에서만 사용한다면 `Use Lagacy Password Encryption` 선택
        - 인터넷을 경유해서 MySQL 서버에 접속하게 된다면 `Use Strong Password Encryption` 선택
    - 설치가 완료되면 MySQL 서버가 자동으로 실행됨
      ```shell
      ps -ef | grep mysqld
      ```
    - 기본 설정으로 설치하면 데이터 디렉터리와 로그 파일들은 `/usr/local/mysql` 디렉터리 하위에 생성됨
        - `bin`: MySQL 서버와 클라이언트 프로그램, 유틸리티
        - `data`: 로그 파일과 데이터 파일
        - `include`: C/C++ 헤더 파일
        - `lib`: 라이브러리 파일
        - `share`: 다양한 지원 파일. 에러 메시지나 샘플 설정 파일(my.cnf)
    - macOS [시스템 환경 설정]에서 MySQL 관리 프로그램을 통해 설정 파일 등록 및 시작과 종료 가능
    - 터미널로 MySQL 시작과 종료
      ```shell
      ## MySQL 서버 시작
      sudo /usr/local/mysql/support-files/mysql.sever start
      ## MySQL 서버 종료
      sudo /usr/local/mysql/support-files/mysql.sever stop
      ```

### 윈도우 MSI 인스톨러 설치

- [윈도우 설치 프로그램 다운로드](https://dev.mysql.com/downloads/mysql/)
    - 설치 유형 선택
        - `Developer Default` 선택 시, MySQL 서버와 클라이언트 도구, MySQL Workbench 같은 GUI 클라이언트 도구가 모두 설치된다.
        - `Custom` 선택 시, 꼭 필요한 소프트웨어만 선택하여 설치할 수 있다.  
          **e.g.** MySQL 서버(MySQL 클라이언트 프로그램이 포함돼 있음), MySQL Shell, MySQL Router 선택
    - 고가용성 옵션 선택
        - Standalone MySQL Server / Classic MySQL Replication : 단일 서버 실행 모드
    - 네트워크 옵션 선택
        - `Development Computer` : 테스트용으로 설정으로, MySQL 서버가 허용하는 커넥션 개수를 적게 설정
        - MySQL 서버의 기본 포트 : `3306`
    - MySQL 서버의 설정이 모두 완료되면 MySQL Router 옵션을 설정하는 화면이 나타나는데, 이 설정 화면은 취소하고 넘어간다.

## 2. MySQL 서버의 시작과 종료

### 설정 파일 및 데이터 파일 준비

- my.conf (my.ini)
    - MySQL 서버가 설치되면 `/etc/my.conf` 설정 파일이 준비된다.
    - macOS, 유닉스 계열에서 `my.conf`이지만, 윈도우 운영체제는 `my.ini` 파일명을 사용한다.

- MySQL 서버를 실행하는데 필요한 초기 데이터 파일(시스템 테이블이 저장되는 데이터 파일)과 트랜잭션 로그(리두 로그) 파일을 생성한다.
    ```shell
    mysqld --default-file=/etc/my.cnf --initialize-insecure
    ```
    - `--initialize-insecure` 옵션을 사용하면, 필요한 초기 데이터 파일과 로그 파일들을 생성하고, 비밀번호가 없는 관리자 계정인 root 유저를 생성한다.
    - 비밀번호를 가진 관리자 계정을 생성하고자 한다면 `--initialize` 옵션을 사용하면 된다.
    - 생성된 관리자 계정의 비밀번호는 에러 로그 파일에 기록된다.
    - 에러 로그 파일의 기본 셩로는 `/var/log/mysqld.log` 파일이다.

### 시작과 종료

- 유닉스 계열 운영체제에서 RPM 패키지로 설치하면 자동으로 `/usr/lib/systemd/system/mysqld.service` 파일이 생성된다.
- `systemctl` 유틸리티를 이용해 MySQL 시작하거나 종료할 수 있다.
    ```shell
    systemctl status mysqld
    systemctl start mysqld
    systemctl stop mysqld
    ```

- `systemd`를 이용해 시작하고 종료할 수도 있지만, [mysqld_safe](https://dev.mysql.com/doc/refman/8.0/en/mysqld-safe.html) 스크립트를 이용해서
  시작하고 종료할 수도 있다.
    - `systemd`를 이용하는 경우에는 MySQL 설정 파일의 `[mysqld_safe]` 섹션을 무시하게 된다.
    - `[mysqld_safe]` 섹션에만 설정 가능한 "malloc-lib"같은 시스템 설정을 적용한다면 mysqld_safe 스크립트로 서버를 시작해야 한다.  
      (`--malloc-lib` : 이 옵션은 동적 링크에 영향을 주는 `LD_PRELOAD` 환경 값을 수정하여 로더가 `mysqld`가 실행될 때 시스템 라이브러리 대신 메모리 할당 라이브러리를 찾을 수
      있도록 한다.)
    - `systemd`를 이용하더라도 `/etc/sysconfig/mysql`에서 `LD_PRELOAD`를 설정하여 할당 라이브러리를 지정할 수도 있다.
    - `mysqld_safe` 는 유닉스에서 `mysqld` 서버를 시작하는 데 권장되는 방법이다.  
      (`mysqld`: MySQL 설치에서 대부분의 작업을 수행하는 단일 다중 스레드 프로그램)


- MySQL 서버를 종료하려면 SHUTDOWN 권한을 가지고 있어야 한다.

#### SHUTDOWN 트랜잭션 옵션

- 트랜잭션이 정상적으로 커밋돼도 데이터 파일에 변경된 내용이 기록되지 않고 로그 파일(리두 로그)에만 기록될 수도 있다.
- MySQL 서버가 종료될 때 모든 커밋된 내용을 데이터 파일에 기록하고 종료할 수 있게 하려면, MySQL 서버의 옵션을 변경하고 종료하면 된다.
- 모든 커밋된 데이터를 데이터 파일에 적용하고 종료하는 것을 클린 셧다운이라고 한다.
- 클린 셧다운으로 종료되면 다시 MySQL 서버가 기동할 때 별도의 트랜잭션 복구 과정을 진행하지 않기 때문에 빠르게 시작할 수 있다.
    ```shell
    mysql > SET GLOBAL innodb_fast_shutdown=0;
    ```
    ```shell
    ## 실행 중인 MySQL 서버 종료
    linux > systemctl stop mysqld.service
    ## 또는 원격으로 MySQL 서버 종료
    mysql > SHUTDOWN;
    ```

### 서버 연결 테스트

- 접속 시도
    ```shell
    ## 소켓 파일을 이용해 접속
    mysql -uroot -p --host=localhost --socket=/tmp/mysql.sock
    ## TCP/IP를 통해 접속
    mysql -uroot -p --host=127.0.0.1 --port=3306
    ## 호스트 주소와 포트를 명시하지 않고 접속
    mysql -uroot -p 
    ```
    - localhost로 명시하면, 소켓 파일을 통해 MySQL 서버에 접속하게 된다.
    - 127.0.0.1을 사용하면 루프백 IP 이기는 하지만, TCP/IP 통신 방식을 사용한다.
    - 별도로 호스트 주소를 명시하지 않으면, localhost가 되어 소켓 파일을 사용하게 된다.

- 원격 서버에서 MySQL 접속 확인
    - Telnet 또는 Netcat 으로 확인
    ```shell
    ## telnet 으로 확인
    linux > telnet 10.2.40.61 3306
    ## telnet 으로 확인
    linux > nc 10.2.40.61 3306 
    ```

### 3. MySQL 서버 업그레이드

1. 인플레이스 업그레이드
    - MySQL 서버의 데이터 파일을 그대로 두고 업그레이드
2. 논리적 업그레이드
    - mysqldump를 통해 새로 업그레이드된 버전의 MySQL 서버에 데이터를 적재하는 방법


- 마이너(패치) 버전 간 업그레이드는 대부분 데이터 파일을 변경하지 않고도 MySQL 서버 프로그램만 재설치 하면 된다.
    - 메이저 버전 간 업그레이드는 직전 버전에서만 허용된다.  
      **e.g.** MySQL 5.1 ➡️ MySQL 8.0 으로 업그레이드  
      (MySQL 5.1 →️ MySQL 5.5 →️ MySQL 5.6 →️ MySQL 5.7 →️ MySQL 8.0)
- 만약 두 단계 이상을 업그레이드 한다면 `mysqldump`로 데이터를 백업받은 후 새로 구축된 서버에 데이터를 적재하는 '논리적 업그레이드'가 더 나은 방법일 수 있다.
- 인플레이스 업그레이드의 경우, GA 버전(서버의 안정성이 확인된 버전)이 아닌 경우 메이저 버전으로 업그레이드가 불가능할 수 있다.

### MySQL 8.0 업그레이드 시 고려사항

- 사용자 인증 방식 변경
    - MySQL 8.0 부터 Caching SHA-2 Authentication 인증 방식이 기본 인증방식으로 바뀌었다.
- 호환성 체크
    - mysqlcheck 유틸리티를 이용해서 호환되지 않는 데이터 타입 또는 함수가 있는지 확인해 볼 것을 권장한다.
      ```shell
      ## mysqlcheck 유틸리티 실행
      linux > mysqlcheck -u root -p --all-database --check-upgrade
      ```
- 외래키 이름의 길이
    - MySQL 8.0에서는 외래키의 이름이 64글자로 제한된다.
      ```shell
      ## 외래키 이름의 길이 체크
      mysql > SELECT TABLE_SCHEMA, TABLE_NAME
              FROM information_schema.TABLES
              WHERE TABLE_NAME IN (SELECT LEFT(SUBSTR(ID, INSTR(ID, '/')+1),
                                               INSTR(SUBSTR(ID, INSTR(ID, '/')+1), 'ibfk_')-1)
                                   FROM information_schema.INNODB_FOREIGN
                                   WHERE LENGTH(SUBSTR(ID, INSTR(ID, '/')+1)) > 64              
                                  );
      ```

- 인덱스 힌트
    - MySQL 5.x에서 사용되던 인덱스 힌트가 있다면 MySQL 8.0에서 먼저 성능 테스트를 수행하자.
- GROUP BY에 사용된 정렬 옵션
    - MySQL 5.x에서 `GROUP BY` 절 컬럼 뒤에 `ASC`나 `DESC`를 사용하고 있다면 제거하거나 다른 방식으로 변경하자.
- 파티션을 위한 공용 테이블스페이스
    - MySQL 8.x에서는 파티션의 각 테이블스페이스를 공용 테이블스페이스에 저장할 수 없다.
      ```shell
      ## 공용 테이블스페이스에 저장된 파티션이 있는지 체크
      mysql > SELECT DISTINCT NAME, SPACE, SPACE_TYPE
              FROM information_schema.INNODB_TABLES
              WHERE NAME LIKE '%#P#%' AND SPACE_TYPE NOT LIKE '%Single%';
      ```

### MySQL 8.0 업그레이드

업그레이드 단계는 크게 두 가지 단계로 나뉘어서 처리된다.

1. 데이터 딕셔너리 업그레이드
    - 데이터 딕셔너리를 FRM 파일에서 InnoDB 테이블로 저장  
      \- MySQL 5.7 버전까지는 데이터 딕셔너리 정보가 FRM 확장자를 가진 파일로 별도로 보관  
      \- MySQL 8.0 버전부터는 데이터 딕셔너리 정보가 트랜잭션이 지원되는 InnoDB 테이블로 저장
3. 서버 업그레이드
    - 시스템 데이터베이스의 테이블 구조를 변경하는 작업

- MySQL 8.0.15 버전까지는 데이터 딕셔너리 업그레이드 작업은 `mysqld` 프로그램이 실행하고, 서버 업그레이드 작업은 `mysql_upgrade` 프로그램이 실행했다.
- **MySQL 8.0.16** 부터는 mysql_upgrade 유틸리티가 없어지고, `mysqld` 프로그램이 시작되면서 데이터 딕셔너리 업그레이드를 실행 후, 시스템 테이블 구조를 버전에 맞게 변경한다.
    - `--upgrade` 옵션을 사용하면 데이터 딕셔너리 및 서버 업그레이드를 수행할지 여부를 제어할 수 있다.
    - `--upgrade` 파라미터를 지정하지 않으면 기본적으로 `AUTO`로 설정된다.   
      (파라미터 값: `AUTO`, `NONE`, `MINIMAL`, `FORCE`)
