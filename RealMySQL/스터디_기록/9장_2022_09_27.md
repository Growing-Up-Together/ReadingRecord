# ✏️ 스터디 기록

- 스터디 일시 : 2022.09.27
- 서기: 위니

## 9장. 옵티마이저와 힌트
- 9.3 고급 최적화


### 학습 내용
- MySQL은 통계 정보와 옵티마이저 옵션으로 최적의 실행 계획을 수립한다. 

#### 옵티마이저 스위치
- MySQL 8.0부터 조인 버퍼를 이용한 조인에서 해시 조인 알고리즘이 사용된다.
  - 메모리 캐시 = 조인 버퍼(Join Buffer)
- 2개 이상의 인덱스를 사용해 쿼리를 처리하기 위해 인덱스 머지가 사용된다.
  - 인덱스 머지에는 합집합, 교집합, 정렬 후 합집합이 있다.
  - 우선순위 큐 : 두 집합에서 중복된 레코드를 프라이머리 키를 통해 걸러내는 알고리즘
- 세미조인은 다른 테이블과 실제 조인을 수행하지 않고, 다른 테이블에서 조건에 일치하는 레코드가 있는지만 체크하는 것이다.
  - 세미조인 방식에는 테이블 풀-아웃, 중복 제거, 퍼스트 매치, 루스 스캔, 구체화가 있다.
- 루스 스캔은 루스 인덱스 스캔과 비슷한 방식으로 사용된다.
- 실행 계획에서 조인 테이블 외에 테이블이 추가된 것은 임시 테이블을 사용한 것이다.
- 중복 제거는 세미 조인 서브 쿼리에 `group by` 절을 넣어주는 것과 동일한 결과를 얻을 수 있다.
- 컨디션 팬아웃은 옵티마이저가 조건을 만족하는 레코드 건수를 예측하여 더 빠른 실행 계획을 만든다.
- 인비저블 인덱스를 설정하면 인덱스를 삭제하지 않고 사용하지 않을 수 있다.
- 인덱스 스킵 스캔은 인덱스의 선행 컬럼이 조건절에 사용되지 않더라도 후행 컬럼의 조건만으로 인덱스를 이용한 쿼리 성능 개선이 가능하다.
- 해시조인은 첫 번째 레코드를 찾는 데 시간이 오래걸리지만, 최종 레코드를 찾는데까지 걸리는 시간은 빠르다. (네스티드 루프 조인은 반대)
  - 해시 조인은 네스티드 루프 조인을 사용할 수 없는 경우에만 사용된다.
  - 메모리에서 모두 처리 가능한 경우 클래식 해시 조인 알고리즘을 사용하고, 조인 버퍼 메모리보다 큰 경우에는 그레이스 해시 조인 알고리즘을 사용한다.
- `order by`, `group by`에서 인덱스를 사용해서 처리 가능한 경우 인덱스의 가중치를 높이 설정하여 실행된다.
  - 옵티마이저가 인덱스에 가중치를 잘못 설정하면 `prefer_ordering_index` 옵션을 OFF로 변경한다.

#### 조인 최적화 알고리즘

- Exhaustive 검색 알고리즘은 모든 테이블의 조합에 대해 실행 계획 비용을 계산하기 때문에 테이블이 늘어나면 실행 계획을 수립하는데 오랜 시간이 걸린다.
- Greedy 검색 알고리즘은 Exhaustive 검색 알고리즘의 시간 소모적인 문제점을 해결하기 위해 도입되었다.
  - 부분 실행 계획을 사용해서 최적 조합을 찾아낸다.
- 조인 최적화를 위한 시스템 변수
  - `optimizer_search_depth`
  - `optimizer_prune_level`


### Issue
- [[9장] Block Nested Loop 조인 실행 계획 관련 질문](https://github.com/Growing-Up-Together/ReadingRecord/issues/28)
  - 조인이 사용된 쿼리의 실행 계획에 조인 버퍼가 사용되면 순서가 흐트러질 수 있기 때문에 주의해야 한다.


### 질문
- `p.328` 
  - "dept_emp 컬럼(16바이트)"라고 나와 있는데, `dept_no`인데 오타인 것인지, dept_emp 테이블의 `PK(dept_no, emp_no)`를 의미하는 것인지?  
    → `dept_emp`가 아니라 `dept_no`인것 같다. (dept_no 16바이트, emp_no 4바이트, from_date 3바이트) 
  - key_len 컬럼이 어떻게 계산되는 걸까?  
    → key_len 컬럼은 데이트 타입에 따라 결정된다. - [MySQL데이터 타입](http://www.incodom.kr/DB_-_%EB%8D%B0%EC%9D%B4%ED%84%B0_%ED%83%80%EC%9E%85/MYSQL), [stackoverflow](https://stackoverflow.com/questions/52464596/mysql-char-varchar-and-decimal-byte-size)
- `p.366` 실행 계획 완료 대상으로 선택된 테이블이 회차에 따라 달라지나?
    - 회차 별로 테이블 depth에 따라 부분 실행 계획에서 최적인 것을 찾아낸다.
- `p.335-336` 세미 조인을 최적화 하는 방법이 생겼다고 했는데, 그러면 서브쿼리를 사용해도 괜찮은건가?
  - 지금은 서브쿼리를 조인으로 풀어서 사용할 필요가 없다.(p.339)
- `p.335` 세미 조인
  - 실제 조인을 수행하지 않고, 서브 쿼리를 내부적으로 조인으로 풀어서 실행하는 조인
- `p.341` 상관 서브쿼리
  - 부모 명령과 자식인 서브쿼리가 특정 관계를 맺는 것을 상관 서브쿼리라 부른다. - [상관 서브쿼리](https://lxxjn0-dev.netlify.app/first-step-sql-lec-24)

<br>

## 다음주 공지
✔️ 스터디 일정 : 10/6(목) 21:00

<br>
